package binarycrows.robot.SeasonCode.Utils;

public class DesiredMetersPerSecondToVoltageLerpTable {
    private double groundAjustFeedForward = 0.129641;
    private double minSpeedForFeedforward = .3;

    private double[][] acceleratingTable = {
        new double[] {
            0, 0, 0.05442118923958075, 0.09996643492937815, 0.15931870391883854, 0.19383626216799604, 0.2333745561624855, 0.27398872210240327, 0.30617522446979945, 0.35952054176395193, 0.3913484201495387, 0.42568666640779146, 0.47652161582927793, 0.5110391740784355, 0.5538947399046621, 0.5842881223630112, 0.6353023837754024, 0.6736751498290112, 0.7144686277598337, 0.7620759613450353, 0.7993728554532158, 0.8429456692430614, 0.8886702269237635, 0.9217532892456832, 0.9583329353902449, 1.00531267700728, 1.0410854191927705, 1.0802650892054506, 1.1095825997183713, 1.166514156830618, 1.2021972430206562, 1.2574253362193082, 1.2642391918736873, 1.3131913653906744, 1.3427778438899522, 1.3737988183164678, 1.4443580867374728, 1.4635444697642772, 1.5090000594586221, 1.5600143208710133, 1.5986560549109792, 1.6147941340924035, 1.6627600916594145, 1.723367544585208, 1.7411194316847747, 1.7781473578065983, 1.8170580598329211, 1.8712999370815973, 1.9323556699846525, 1.9283211501892963, 1.9829216514197818, 2.0491774320590737, 2.081901870399184, 2.1217091323800306, 2.1629508902881147, 2.2055374881279843, 2.221496255318504, 2.2861382280396536, 2.329890353820404, 2.31339365065717, 2.3932771426052204, 2.451284571662895, 2.4727123545760086, 2.5347543034290396, 2.5760857173325764, 2.6006514600865223, 2.6448518658445344, 2.6753349042983356, 2.709852462547493, 2.7348664852787006, 2.8108051134268472, 2.845950263644171, 2.894902437161158, 2.919019899937842, 2.974516961122851, 2.9720065932501853, 3.063814332593399, 3.0765454839476334, 3.0889180113200587, 3.155263447954803, 3.2160502128715014, 3.2261813403576176, 3.3017613445239546, 3.3236374074143296, 3.3534928538999647, 3.413831338839401, 3.458031744597413, 3.4521144488975573, 3.534687620709178, 3.5389911084908916, 3.63402646367039, 3.66522675008781, 3.6739233816466887, 3.744930930044956, 3.7677932088853066, 3.789400303789325, 3.862559596078448, 3.8706286356691604, 3.9425327440219506, 3.9590294471851846, 3.99309872545708, 4.0291404356289275, 4.090823760500149, 4.132424142390043, 4.147217381639682, 4.185500491697838, 4.22055598591971, 4.2904876623725485, 4.351364083284699, 4.342308827744011, 4.396550704992687, 4.466123757463716, 4.4245233755738225, 4.525655338444081, 4.610918190119273, 4.5842903594699225, 4.689008562158276, 4.698332785685321, 4.703801801407915, 4.771402421978992, 4.795878508737485, 4.876479248649154, 4.8654515612085145, 4.90866575101655, 4.865003281231253, 4.8893000559988415, 4.859892889490468, 4.899610495475863, 4.866437777158491, 4.9431833092657085, 4.9185279105163096
        }, new double[]{
            0, 0.1, 0.2, 0.30000000000000004, 0.4, 0.5, 0.6, 0.7, 0.7999999999999999, 0.8999999999999999, 0.9999999999999999, 1.0999999999999999, 1.2, 1.3, 1.4000000000000001, 1.5000000000000002, 1.6000000000000003, 1.7000000000000004, 1.8000000000000005, 1.9000000000000006, 2.0000000000000004, 2.1000000000000005, 2.2000000000000006, 2.3000000000000007, 2.400000000000001, 2.500000000000001, 2.600000000000001, 2.700000000000001, 2.800000000000001, 2.9000000000000012, 3.0000000000000013, 3.1000000000000014, 3.2000000000000015, 3.3000000000000016, 3.4000000000000017, 3.5000000000000018, 3.600000000000002, 3.700000000000002, 3.800000000000002, 3.900000000000002, 4.000000000000002, 4.100000000000001, 4.200000000000001, 4.300000000000001, 4.4, 4.5, 4.6, 4.699999999999999, 4.799999999999999, 4.899999999999999, 4.999999999999998, 5.099999999999998, 5.1999999999999975, 5.299999999999997, 5.399999999999997, 5.4999999999999964, 5.599999999999996, 5.699999999999996, 5.799999999999995, 5.899999999999995, 5.999999999999995, 6.099999999999994, 6.199999999999994, 6.299999999999994, 6.399999999999993, 6.499999999999993, 6.5999999999999925, 6.699999999999992, 6.799999999999992, 6.8999999999999915, 6.999999999999991, 7.099999999999991, 7.19999999999999, 7.29999999999999, 7.39999999999999, 7.499999999999989, 7.599999999999989, 7.699999999999989, 7.799999999999988, 7.899999999999988, 7.999999999999988, 8.099999999999987, 8.199999999999987, 8.299999999999986, 8.399999999999986, 8.499999999999986, 8.599999999999985, 8.699999999999985, 8.799999999999985, 8.899999999999984, 8.999999999999984, 9.099999999999984, 9.199999999999983, 9.299999999999983, 9.399999999999983, 9.499999999999982, 9.599999999999982, 9.699999999999982, 9.799999999999981, 9.89999999999998, 9.99999999999998, 10.09999999999998, 10.19999999999998, 10.29999999999998, 10.399999999999979, 10.499999999999979, 10.599999999999978, 10.699999999999978, 10.799999999999978, 10.899999999999977, 10.999999999999977, 11.099999999999977, 11.199999999999976, 11.299999999999976, 11.399999999999975, 11.499999999999975, 11.599999999999975, 11.699999999999974, 11.799999999999974, 11.899999999999974, 11.999999999999973, 12.099999999999973, 12.199999999999973, 12.299999999999972, 12.399999999999972, 12.499999999999972, 12.599999999999971, 12.69999999999997, 12.79999999999997, 12.89999999999997, 12.99999999999997
        }
    };

    private double[][] deceleratingTable = {
        new double[] {
            // Meters Per Second
        }, new double[]{
            // Voltage
        }
    };


    public double metersPerSecondToVoltage(double desiredMetersPerSecond, double currentVelocity) {
          boolean isAccelerating = desiredMetersPerSecond >= currentVelocity;
          double voltage = 0;
     
          if(isAccelerating) {
             voltage = lerp(acceleratingTable, Math.abs(desiredMetersPerSecond)) + groundAjustFeedForward;
          } else {
              double rawVoltage = lerp(deceleratingTable, Math.abs(desiredMetersPerSecond));
              double feedForword = Math.abs(desiredMetersPerSecond) > minSpeedForFeedforward ? groundAjustFeedForward : 0;
              voltage = rawVoltage + feedForword;
          }
          voltage *= Math.signum(desiredMetersPerSecond);
          return voltage;
     }

    private double lerp(double[][] lerpTable, double input) {
        int low = 0;
        int high = lerpTable[0].length - 1;
        int closestLowerIndex = -1;
    
        while (low <= high) {
            int mid = (low + high) / 2;
            double midVal = lerpTable[0][mid];
    
            if (midVal <= input) {
                closestLowerIndex = mid;
                low = mid + 1;
            } else {
                high = mid - 1;
            }
        }
        double output = 0;
        if(closestLowerIndex == -1) {
            output = 0;
        } else if(closestLowerIndex == high) {
            output = lerpTable[1][high];
        } else {
            double lowNumber = lerpTable[1][closestLowerIndex];
            double highNumber = lerpTable[1][closestLowerIndex+1];
            double outputDelta = highNumber - lowNumber;
            double inputLowNumber = lerpTable[0][closestLowerIndex];
            double inputHighNumber = lerpTable[0][closestLowerIndex+1];
            double inputDelta = inputHighNumber - inputLowNumber;
            output = lowNumber + (outputDelta * ((input - inputLowNumber)/ inputDelta));
        }
        return output;
    }
}
